{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
    <form method="POST" action="{{ url_for('handle_search') }}">
        <div class="mb-4">
            <input type="text" class="form-control form-control-lg rounded-pill border-0 shadow-sm" 
                   name="query" id="query" placeholder="Enter your search query" 
                   value="{{ query }}" autofocus>
        </div>
    </form>

    {% if results %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="text-secondary">Showing results {{ from_ + 1 }}-{{ from_ + results|length }} out of {{ total }}</div>
        <div class="d-flex gap-2">
            {% if from_ > 0 %}
                <form method="POST">
                    <input type="hidden" name="query" value="{{ query }}">
                    <input type="hidden" name="from_" value="{{ from_ - 5 }}">
                    <button type="submit" class="btn btn-outline-primary">← Previous</button>
                </form>
            {% endif %}
            {% if from_ + results|length < total %}
                <form method="POST">
                    <input type="hidden" name="query" value="{{ query }}">
                    <input type="hidden" name="from_" value="{{ from_ + 5 }}">
                    <button type="submit" class="btn btn-outline-primary">Next →</button>
                </form>
            {% endif %}
        </div>
    </div>

    <div class="row g-4">
        <!-- Filters -->
        <div class="col-md-3">
            <a href="javascript:history.back(1)" class="text-decoration-none text-primary mb-4 d-inline-block">← Back</a>
            {% for agg in aggs %}
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-light border-0">
                        <h6 class="mb-0">{{ agg }}</h6>
                    </div>
                    <div class="card-body">
                        {% for key, count in aggs[agg].items() %}
                            <form method="POST" class="mb-2">
                                <input type="hidden" name="query" value="{{ agg|lower }}:{{key}} {{ query }}">
                                <button type="submit" class="btn btn-link text-start w-100 p-0 text-decoration-none"
                                        {% if aggs[agg]|length == 1 %} disabled{% endif %}>
                                    {{ key }} <span class="text-muted">({{ count }})</span>
                                </button>
                            </form>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Results -->
        <div class="col-md-9">
            {% for result in results %}
                <div class="card border-0 shadow-sm mb-3 hover-shadow-md position-relative">
                    <div class="card-body p-3">
                        <div class="row g-0">
                            <!-- Thumbnail -->
                            <div class="col-auto">
                                <div class="rounded-3 bg-light d-flex align-items-center justify-content-center" 
                                     style="width: 100px; height: 100px;">
                                    {% if result._source.image %}
                                        <img src="https://www.spark.co.nz{{ result._source.image[0] }}" 
                                             class="img-fluid rounded-3" 
                                             alt="{{ result._source.name }}"
                                             style="object-fit: cover; width: 100px; height: 100px;">
                                    {% else %}
                                        <i class="bi bi-image text-secondary" style="font-size: 2rem;"></i>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Content -->
                            <div class="col ps-3">
                                <div class="position-absolute top-0 end-0 mt-3 me-3">
                                    <span class="text-muted"></span>
                                </div>
                                <h5 class="mb-2">
                                    <a href="{{ url_for('get_document', doc_id=result._id) }}" 
                                       class="text-decoration-none stretched-link">
                                        {{ result._source.name }}
                                    </a>
                                </h5>
                                <p class="text-secondary mb-2">{{ result._source.description }}</p>
                                <div class="text-muted small d-flex gap-2">
                                    <span>Category: {{ result._source.category }}</span>
                                    <span>•</span>
                                    <span>Updated: {{ result._source.updated_at | default(result._source.created_on) }}</span>
                                    {% if result._score %}
                                        <span>•</span>
                                        <span>Score: {{ "%.2f"|format(result._score) }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="position-absolute top-50 end-0 translate-middle-y me-4">
                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center"
                                 style="width: 30px; height: 30px;">
                                <span class="text-primary">›</span>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    

    {% elif request.method == 'POST' %}
        <div class="alert alert-info border-0 shadow-sm">
         No results found.
        {% if suggestion %}
            <p>Did you mean: <a href="#" onclick="document.getElementById('query').value='{{ suggestion }}'; document.forms[0].submit(); return false;">{{ suggestion }}</a>?</p>
        {% endif %}
        </div>
        <script>
            window.elasticAnalytics.trackSearch({
                search: {
                    query: "{{ query  }}",
                    page: {
                        current: 1,
                        size: 5
                    },
                    results: {
                        items: [],
                        total_results: 0
                    },
                    sort: {
                        name: "relevance"
                    },
                    search_application: "spark-search"
                }
            });
        </script>
    {% endif %}
</div>

<style>
.hover-shadow-md {
    transition: all 0.2s ease-in-out;
}
.hover-shadow-md:hover {
    box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
    transform: translateY(-1px);
}
</style>

<script>
const searchInput = document.getElementById('query');
const suggestionsContainer = document.createElement('div');
suggestionsContainer.className = 'suggestions border rounded shadow-sm position-absolute bg-white w-100 d-none';
searchInput.parentElement.style.position = 'relative';
searchInput.parentElement.appendChild(suggestionsContainer);

let debounceTimer;
searchInput.addEventListener('input', (e) => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
        const query = e.target.value.trim();
        if (query.length < 2) {
            suggestionsContainer.classList.add('d-none');
            return;
        }
        
        fetch(`/suggest?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(suggestions => {
                suggestionsContainer.innerHTML = '';
                if (suggestions.length === 0) {
                    suggestionsContainer.classList.add('d-none');
                    return;
                }
                
                suggestions.forEach(suggestion => {
                    const div = document.createElement('div');
                    div.className = 'p-2 hover-bg-light cursor-pointer';
                    div.textContent = suggestion.text;
                    div.addEventListener('click', () => {
                        searchInput.value = suggestion.text;
                        suggestionsContainer.classList.add('d-none');
                        searchInput.form.submit();
                    });
                    suggestionsContainer.appendChild(div);
                });
                suggestionsContainer.classList.remove('d-none');
            });
    }, 300);
});

document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
        suggestionsContainer.classList.add('d-none');
    }
});
</script>

<script type="text/javascript">
    window.elasticAnalytics.createTracker({
      endpoint: "https://038627544e264087a75829b9465cd3cd.australia-southeast1.gcp.elastic-cloud.com:443",
      collectionName: "spark",
      apiKey: "Y216cmtwUUJYaHV1YS11TXJRdm46UWpPUTFYSnRSTWlsb3dETEtWeENHZw==",
      // Optional: sampling rate percentage: 0-1, 0 = no events, 1 = all events
      // sampling: 1,
      user: {
        token: () => "1337"
    }
    });
    </script>

<script>
function trackSearchEvent(query, results, from) {
    const searchEvent = {
        search: {
            query: query,
            page: {
                current: Math.floor(from / 5) + 1,
                size: 5
            },
            results: {
                items: results.map(result => ({
                    document: {
                        id: result._id,
                        index: 'search-dev-spark-product-index'
                    },
                    page: {
                        url: `/document/${result._id}`
                    }
                })),
                total_results: {{ total | default(0) }}
            },
            sort: {
                name: "relevance"
            },
            search_application: "spark-search"
        }
    };
    
    window.elasticAnalytics.trackSearch(searchEvent);
}

// Track result clicks
document.querySelectorAll('.card').forEach((card, index) => {
    card.addEventListener('click', function() {
        const docId = this.querySelector('a').href.split('/').pop();
        window.elasticAnalytics.trackSearchClick({
            document: {
                id: docId,
                index: 'search-dev-spark-product-index'
            },
            search: {
                query: "{{ query  }}",
                filters: {{ filters|tojson if filters else '[]' }},
                page: {
                    current: Math.floor({{ from_ }} / 5) + 1,
                    size: 5
                },
                results: {
                    total_results: {{ total }}
                }
            },
            click: {
                position: index + {{ from_ }} + 1
            }
        });
    });
});
</script>
{% endblock %}